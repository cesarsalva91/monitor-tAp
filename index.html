<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa SIM7600 - Salta Capital</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" 
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  #map {
    height: 100vh;
    width: 100%;
  }

  #logo {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 120px; 
    z-index: 1000;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }
</style>
</head>

<body>

<img id="logo" src="img/lusal.jpeg" alt="Logo">

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Ubicaci√≥n inicial
const map = L.map('map').setView([-24.7829, -65.4122], 13);

// Mapa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);


// ICONOS RESPONSIVOS

function getIconSize() {
  return window.innerWidth < 768 ? [60, 60] : [40, 40];
}

function createIcon(svgBase64) {
  return L.icon({
    iconUrl: svgBase64,
    iconSize: getIconSize()
  });
}


// ICONOS 


// ONLINE + ON
const iconOnlineOn = createIcon(
"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMzIgNkMyNCA2IDE4IDEyIDE4IDIwQzE4IDI5IDI2IDM4IDMxIDQ2QzMxLjQgNDYuNiAzMS43IDQ3LjIgMzIgNDcuOEMzMi4zIDQ3LjIgMzIuNiA0Ni42IDMzIDQ2QzM4IDM4IDQ2IDI5IDQ2IDIwQzQ2IDEyIDQwIDYgMzIgNloiIGZpbGw9IiMxNWIzMTgiIHN0cm9rZT0iIzBiNmUwYiIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIyMiIgcj0iNyIgZmlsbD0iI2ZmZmZmZiIvPgogIDxjaXJjbGUgY3g9IjMyIiBjeT0iMjIiIHI9IjQiIGZpbGw9IiMwYjZlMGIiLz4KPC9zdmc+"
);

// ONLINE + OFF
const iconOnlineOff = createIcon(
"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMzIgNkMyNCA2IDE4IDEyIDE4IDIwQzE4IDI5IDI2IDM4IDMxIDQ2QzMxLjQgNDYuNiAzMS43IDQ3LjIgMzIgNDcuOEMzMi4zIDQ3LjIgMzIuNiA0Ni42IDMzIDQ2QzM4IDM4IDQ2IDI5IDQ2IDIwQzQ2IDEyIDQwIDYgMzIgNloiIGZpbGw9IiNlNjAwMDAiIHN0cm9rZT0iIzk5MDAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIyMiIgcj0iNyIgZmlsbD0iI2ZmZmZmZiIvPgogIDxjaXJjbGUgY3g9IjMyIiBjeT0iMjIiIHI9IjQiIGZpbGw9IiM5OTAwMDAiLz4KPC9zdmc+"
);

// OFFLINE
const iconOffline = createIcon(
"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMzIgNkMyNCA2IDE4IDEyIDE4IDIwQzE4IDI5IDI2IDM4IDMxIDQ2QzMxLjQgNDYuNiAzMS43IDQ3LjIgMzIgNDcuOEMzMi4zIDQ3LjIgMzIuNiA0Ni42IDMzIDQ2QzM4IDM4IDQ2IDI5IDQ2IDIwQzQ2IDEyIDQwIDYgMzIgNloiIGZpbGw9IiNlNjAwMDAiIHN0cm9rZT0iIzk5MDAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIyMiIgcj0iNyIgZmlsbD0iI2ZmZmZmZiIvPgogIDxjaXJjbGUgY3g9IjMyIiBjeT0iMjIiIHI9IjQiIGZpbGw9IiM5OTAwMDAiLz4KICA8bGluZSB4MT0iMjAiIHkxPSIxMCIgeDI9IjQ0IiB5Mj0iMzQiIHN0cm9rZT0iI2ZmMDAwMCIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KICA8bGluZSB4MT0iNDQiIHkxPSIxMCIgeDI9IjIwIiB5Mj0iMzQiIHN0cm9rZT0iI2ZmMDAwMCIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+"
);



// API Google Apps Script

const apiUrl = "https://script.google.com/macros/s/AKfycbypJMUcPMfJM89bHpnqHDlVjt3wyF7wfDvTJiooZNs9lR6qlfkCYTd9e3vbXzBvDMvH1A/exec";

let markers = {};

function actualizarMapa() {
  fetch(apiUrl)
    .then(r => r.json())
    .then(data => {

      data.forEach(eq => {
        const id = eq.name;

        // Icono
        let icon;
        if (eq.online == 0) icon = iconOffline;
        else icon = eq.on == 1 ? iconOnlineOn : iconOnlineOff;

        
        // TIMESTAMP

        let rawTs = "";

        try { rawTs = String(eq.timestamp).replace(/"/g, ""); }
        catch { rawTs = ""; }

        let fechaFormateada = "";

        if (rawTs.length > 0 && !isNaN(new Date(rawTs).getTime())) {
          fechaFormateada = new Date(rawTs).toLocaleString("es-AR", {
            timeZone: "America/Argentina/Buenos_Aires",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
          });
        }

        // Popup
        const popupHTML = `
          <div style="font-size:1.5rem;">
            <strong>${eq.name}</strong><br>
            Voltaje: ${eq.volt}<br>
            <span style="font-size:0.75rem; opacity:0.8;">
              ${fechaFormateada}
            </span>
          </div>`;
  
        if (markers[id]) {
          markers[id].setLatLng([eq.lat, eq.long]);
          markers[id].setIcon(icon);
          markers[id].setPopupContent(popupHTML);
        } else {
          markers[id] = L.marker([eq.lat, eq.long], { icon })
            .addTo(map)
            .bindPopup(popupHTML);
        }
      });
    });
}

// Resize iconos
window.addEventListener('resize', () => {
  for (let id in markers) {
    const m = markers[id];
    m.options.icon.options.iconSize = getIconSize();
    m.setIcon(m.options.icon);
  }
});

// Loop
setInterval(actualizarMapa, 1000);
actualizarMapa();
</script>

</body>
</html>
